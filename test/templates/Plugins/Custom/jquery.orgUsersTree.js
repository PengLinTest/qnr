(function(a){var n=1;a.widget("custom.orgUsersTree",{_zTreeId:"tree_orgUsersTree",options:{treeType:1,userTag:"\u7528\u6237",orgTag:"\u7ec4\u7ec7",userUrl:"/BaseService.svc/GetOrgUsersTree",orgUrl:"/BaseService.svc/GetOrgTree",width:"",functionId:0,operateId:0,showSelectAdmin:0,onlyorgID:0},_create:function(){n++;a.ajax({url:"/Plugins/Custom/OrgUsersTree.html",async:!1,success:function(c){a("#div_orgUsersTree_tempDiv").remove();a("<div id='div_orgUsersTree_tempDiv'></div>").appendTo("body");a("#div_orgUsersTree_tempDiv").hide();
a("#div_orgUsersTree_tempDiv").html(c)},dataType:"html"});Transfer.loadCSS(["/Plugins/ZTree/zTreeStyle.css"]);this.wrapper=a("#div_orgUsersTree_tempDiv").find("#div_orgUsersTree").appendTo(this.element);this.options.width&&this.wrapper.width(this.options.width);this.wrapper.find("#div_orgUsersTree_usersSelector").hide();this._zTreeId="tree_orgUsersTree"+n;this.wrapper.find("#div_orgUsersTree_usersSelector .theZtree").attr("id",this._zTreeId);10==this.options.showSelectAdmin&&this.wrapper.find(".btnshowselectadmin").show();
this._initOuterActions();this._on(this.wrapper.find(".tags_addtag"),{click:function(a,d){this._getOrgUsersTree();this._openDialog();a.preventDefault();return!1}})},_dialog:null,_openDialog:function(){if(!this._dialog){var c="\u9009\u62e9"+(1==this.options.treeType)?this.options.userTag:this.options.orgTag;this._dialog=a(this.wrapper).find("#div_orgUsersTree_usersSelector").dialog({autoOpen:!1,width:"520",height:"550",title:c,modal:!0,resizable:!1,show:{effect:"clip",duration:300},hide:{effect:"clip",
duration:300}})}this._dialog.dialog("open")},_openUnshowDialog:function(){if(!this._dialog){var c="\u9009\u62e9"+(1==this.options.treeType)?this.options.userTag:this.options.orgTag;this._dialog=a(this.wrapper).find("#div_orgUsersTree_usersSelector").dialog({autoOpen:!1,width:"520",height:"550",title:c,modal:!0,resizable:!1,show:{effect:"clip",duration:300},hide:{effect:"clip",duration:300}})}},_getOrgUsersTree:function(c){var d=this,b="",f=1==d.options.treeType;0<a("#"+d._zTreeId).children().length||
(b=f?d.options.userUrl:d.options.orgUrl,AccountGlobalInfo.executeWhenUser(function(h){Service.post({url:b,params:{UserID:h.UserID,FunctionID:d.options.functionId,OperateID:d.options.operateId,IsShowCompanyAdmin:10==d.options.showSelectAdmin?10:0,OrgID:0<d.options.onlyorgID?d.options.onlyorgID:0},success:function(b){0<b.Items.length&&Transfer.loadScripts(["/Plugins/ZTree/jquery.ztree.core-3.5.min.js","/Plugins/ZTree/jquery.ztree.excheck-3.5.min.js"],function(){f&&a.each(b.Items,function(a,b){2>b.RowType?
b.nocheck=!0:(b.nocheck=!1,b.iconSkin="icon09")});d._zTreeInit(b.Items,d._zTreeSettings);"function"===typeof c&&c()})},mask:function(){a(d._dialog).mask("\u6b63\u5728\u52a0\u8f7d\u6570\u636e...")},unmask:function(){a(d._dialog).unmask("")}})}),f&&AccountGlobalInfo.executeWhenUser(function(b){Service.post({url:"/ContactsService.svc/GetFriendGroupList",params:{UserID:b.UserID},success:function(b){0<b.Items.length&&Transfer.loadScripts(["/Plugins/ZTree/jquery.ztree.core-3.5.min.js","/Plugins/ZTree/jquery.ztree.excheck-3.5.min.js"],
function(){f&&a.each(b.Items,function(a,b){2>b.RowType?b.nocheck=!0:(b.nocheck=!1,b.iconSkin="icon09")});d.UserBook_zTreeInit(d._UserBookSettings,b.Items);"function"===typeof c&&c()})}})}))},_UserBookSettings:{check:{enable:!0,chkboxType:{Y:"s",N:"s"}},data:{simpleData:{enable:!0,idKey:"OrigValue",pIdKey:"ParentOrgID",rootPId:0},key:{name:"Name"}},callback:{onCheck:function(c,d,b){c=a.fn.zTree.getZTreeObj(d).getCheckedNodes(!0).length;a("#"+d).parents("#div_orgUsersTree_usersSelector").find("#em_UsersBookTree_selectedCount").html("["+
c+"]")}}},_zTreeSettings:{check:{enable:!0,chkboxType:{Y:"s",N:"s"}},data:{simpleData:{enable:!0,idKey:"OrgID",pIdKey:"ParentOrgID",rootPId:0},key:{name:"Name"}},callback:{onCheck:function(c,d,b){c=a.fn.zTree.getZTreeObj(d).getCheckedNodes(!0).length;a("#"+d).parents("#div_orgUsersTree_usersSelector").find("#em_orgUsersTree_selectedCount").html("["+c+"]")}}},UserBook_zTreeInit:function(c,d){var b=this,f=function(d,k){a.fn.zTree.init(a(b._dialog).find("#UserBookTree"),k,d);var c=a.fn.zTree.getZTreeObj("UserBookTree");
c&&c.expandAll(!0);a(b._dialog).find("#em_UsersBookTree_selectedCount").html("[0]");var e=a(b._dialog).find("#selectAllUserBook");c.checkAllNodes(!1);e.data("isCheckAll",!0);e.text("\u5168\u9009");10==b.options.showSelectAdmin&&(e=a(b._dialog).find("#selectAllAdmin"),c.checkAllNodes(!1),e.data("isCheckAllAdmin",!0),e.text("\u5168\u9009\u7ba1\u7406\u5458"))};f(d,c);var h=function(){var m=a(b._dialog).find("#txtUserBookNameFilter").val()||null,k=a.extend(!0,[],d);m&&(k=a.grep(k,function(a){if(a)return 0<=
a.Name.indexOf(m)}));f(k,c)};a(b._dialog).find("#txtUserBookNameFilter").bind("keydown",function(b){if(b.keyCode===a.ui.keyCode.ENTER)return b.stopPropagation(),b.preventDefault(),h(),!1});a(b._dialog).find("#btSearchUserBook").unbind("click").click(function(a){a.preventDefault();h();return!1})},_zTreeInit:function(c,d){var b=this,f=function(d,c){a.fn.zTree.init(a(b._dialog).find(".theZtree"),c,d);var k=a.fn.zTree.getZTreeObj(b._zTreeId);k&&k.expandAll(!0);a(b._dialog).find("#em_orgUsersTree_selectedCount").html("[0]");
var l=a(b._dialog).find("#selectAllOrg");k.checkAllNodes(!1);l.data("isCheckAll",!0);l.text("\u5168\u9009");10==b.options.showSelectAdmin&&(l=a(b._dialog).find("#selectAllAdmin"),k.checkAllNodes(!1),l.data("isCheckAllAdmin",!0),l.text("\u5168\u9009\u7ba1\u7406\u5458"))};f(c,d);(function(){a(b._dialog).find("#OrgUserTreeDisplay").unbind("click").click(function(){a(b._dialog).find("#UserBookTreeDiv").hide();a(b._dialog).find("#OrgUserTreeDiv").show();a(b._dialog).find(".TabClass").removeClass("current");
a(b._dialog).find("#OrgUserTreeDisplay").addClass("current")});a(b._dialog).find("#UserBookTreeDisplay").unbind("click").click(function(){a(b._dialog).find("#UserBookTreeDiv").show();a(b._dialog).find("#OrgUserTreeDiv").hide();a(b._dialog).find(".TabClass").removeClass("current");a(b._dialog).find("#UserBookTreeDisplay").addClass("current")});a(b._dialog).find("#selectAllUserBook").unbind("click").click(function(d){var c=a(b._dialog).find("#selectAllUserBook"),l=!1!=c.data("isCheckAll"),e=a.fn.zTree.getZTreeObj("UserBookTree"),
g=0;l?(e.checkAllNodes(!0),c.data("isCheckAll",!1),c.text("\u5168\u4e0d\u9009")):(e.checkAllNodes(!1),c.data("isCheckAll",!0),c.text("\u5168\u9009"));g=e.getCheckedNodes(!0).length;a(b._dialog).find("#em_UsersBookTree_selectedCount").html("["+g+"]");d.preventDefault();return!1});a(b._dialog).find("#selectAllOrg").unbind("click").click(function(c){var d=a(b._dialog).find("#selectAllOrg"),l=!1!=d.data("isCheckAll"),e=a.fn.zTree.getZTreeObj(b._zTreeId),g=0;l?(e.checkAllNodes(!0),d.data("isCheckAll",
!1),d.text("\u5168\u4e0d\u9009"),a(b._dialog).find("#selectAllAdmin").data("isCheckAllAdmin",!0),a(b._dialog).find("#selectAllAdmin").text("\u5168\u9009\u7ba1\u7406\u5458")):(e.checkAllNodes(!1),d.data("isCheckAll",!0),d.text("\u5168\u9009"));g=e.getCheckedNodes(!0).length;a(b._dialog).find("#em_orgUsersTree_selectedCount").html("["+g+"]");c.preventDefault();return!1});a(b._dialog).find("#selectAllAdmin").unbind("click").click(function(d){var c=a(b._dialog).find("#selectAllAdmin"),l=!1!=c.data("isCheckAllAdmin"),
e=a.fn.zTree.getZTreeObj(b._zTreeId),g=0;if(l){e.checkAllNodes(!1);for(var l=e.getNodesByParam("UserType",3,null),g=0,f=l.length;g<f;g++)e.checkNode(l[g],!0);c.data("isCheckAllAdmin",!1);c.text("\u5168\u4e0d\u9009")}else e.checkAllNodes(!1),c.data("isCheckAllAdmin",!0),c.text("\u5168\u9009\u7ba1\u7406\u5458");a(b._dialog).find("#selectAllOrg").data("isCheckAll",!0);a(b._dialog).find("#selectAllOrg").text("\u5168\u9009");g=e.getCheckedNodes(!0).length;a(b._dialog).find("#em_orgUsersTree_selectedCount").html("["+
g+"]");d.preventDefault();return!1});var h=function(){var m=a(b._dialog).find("#txtOrgNameFilter").val()||null,k=a.extend(!0,[],c);m&&(k=a.grep(k,function(a){if(a)return 0<=a.Name.indexOf(m)}));f(k,d)},h=function(){var m=a(b._dialog).find("#txtOrgNameFilter").val()||null,k=a.extend(!0,[],c);m&&(k=a.grep(k,function(a){if(a&&a.Name)return 0<=a.Name.indexOf(m)}));f(k,d)};a(b._dialog).find("#txtOrgNameFilter").bind("keydown",function(b){if(b.keyCode===a.ui.keyCode.ENTER)return b.stopPropagation(),b.preventDefault(),
h(),!1});a(b._dialog).find("#btSearchUserOrg").unbind("click").click(function(a){a.preventDefault();h();return!1});a(b._dialog).find(".SelectedOrgOK").unbind("click").click(function(c){c.preventDefault();a(b._dialog).dialog("close");c=a.fn.zTree.getZTreeObj(b._zTreeId).getCheckedNodes(!0);var d=a.fn.zTree.getZTreeObj("UserBookTree");if(d)var f=d.getCheckedNodes(!0);var e=a(b.wrapper).find("#div_orgUsersTree_outerSelector #RecieveOrg"),g="",g=null;e.children("span").remove();e.empty();for(var h=0,
p=c.length;h<p;h++)g=c[h],g=String.format('<span > <a href="#" title ="{0}">{0}<span class="icon-close"><i></i></span></a> </span>',g.Name),e.append(g),e.children("span").last().data("OrgUser",c[h]);if(d)for(h=0,p=f.length;h<p;h++){for(var g=f[h],d=!0,q=0,n=c.length;q<n;q++)g.OrigValue==c[q].OrigValue&&(d=!1);!0==d&&(g=String.format('<span > <a href="#" title ="{0}">{0}<span class="icon-close"><i></i></span></a> </span>',g.Name),e.append(g),e.children("span").last().data("OrgUser",f[h]))}a(b.wrapper).find("#div_orgUsersTree_outerSelector #RecieveOrgCount").html(e.children("span").length);
e.find(".icon-close").unbind("click").click(function(c){c.preventDefault();c=a.fn.zTree.getZTreeObj(b._zTreeId);var d=a.fn.zTree.getZTreeObj("UserBookTree"),e=a(this).parents("span").data("OrgUser"),f=c.getNodesByParam("OrgID",e.OrgID,null)[0],g=0;d&&((UserBookNode=d.getNodesByParam("OrigValue",e.OrigValue,null)[0])&&d.checkNode(UserBookNode,!1),g=d.getCheckedNodes(!0).length);f&&c.checkNode(f,!1);checkCount=c.getCheckedNodes(!0).length+g;a(b._dialog).find("#em_orgUsersTree_selectedCount").html("["+
checkCount+"]");a(this).parents("span").remove();a(b.wrapper).find("#div_orgUsersTree_outerSelector #RecieveOrgCount").html(checkCount);return!1});return!1})})()},_initOuterActions:function(){var c=this;a(c.wrapper).find("#div_orgUsersTree_outerSelector .reselect").unbind("click").click(function(d){d.preventDefault();0<a(this).parents("#div_orgUsersTree_outerSelector .tagsinput").find("#RecieveOrg").children("span").length&&(0<a(c.wrapper).find("#div_orgUsersTree_outerSelector .rec-selected").length?
(a(c.wrapper).find("#div_orgUsersTree_outerSelector .recipientscon").removeClass("rec-selected"),a(this).removeClass("selected")):(a(c.wrapper).find("#div_orgUsersTree_outerSelector .recipientscon").addClass("rec-selected"),a(this).addClass("selected")));return!1})},getUsers:function(){var c=[],d=null;a(a(this.wrapper).find("#div_orgUsersTree_outerSelector #RecieveOrg").children("span")).each(function(b,f){d=a(f).data("OrgUser");c.push(d.OrigValue)});return c},getUserNames:function(){var c=[],d=null;
a(a(this.wrapper).find("#div_orgUsersTree_outerSelector #RecieveOrg").children("span")).each(function(b,f){d=a(f).data("OrgUser");c.push(d.Name)});return c},openDialog:function(){a(this.wrapper).find("#div_orgUsersTree_outerSelector .tags_addtag").trigger("click");return!1},getTreeObj:function(){return a.fn.zTree.getZTreeObj(this._zTreeId)},clear:function(){a.fn.zTree.getZTreeObj(this._zTreeId)&&a(this._dialog).find("#txtOrgNameFilter").val("")},emptyTree:function(){a.fn.zTree.getZTreeObj(this._zTreeId)&&
(a("#"+this._zTreeId).empty(),a(this._dialog).find("#UserBookTree").empty(),a(this.wrapper).find("#div_orgUsersTree_outerSelector #RecieveOrg").empty())},_selectUsers:function(c,d){var b=a.fn.zTree.getZTreeObj(c._zTreeId),f=null;if(b){for(var h=0,m=d.length;h<m;h++)(f=b.getNodesByParam("OrgID",parseInt(d[h])+1E5,null)[0])&&b.checkNode(f,!0);b=b.getCheckedNodes(!0).length;a(c._dialog).find("#em_orgUsersTree_selectedCount").html("["+b+"]");a(c._dialog).find("#SelectedOrgOK").trigger("click")}},setUsers:function(a){var d=
this;d._openUnshowDialog();d._getOrgUsersTree(function(){d._selectUsers(d,a)})},_destroy:function(){this.wrapper.remove()}})})(jQuery);
